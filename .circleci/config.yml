version: 2
jobs:
  build:
    machine: true
    environment:
      VERSION: 0.1
    steps:
      - checkout
      - run: 
          name: Check if Singularity recipe exists
          command: test -f Singularity
      - run:
          name: Set-up singularity
          command: |
            chmod u+x *.sh
            /bin/bash setup.sh
      - run:
          name: Checking singularity build
          command: |
              singularity selftest
      - run:
          name: Building singularity container
          command: |
              export BUILD_NAME=${CIRCLE_PROJECT_USERNAME}_${CIRCLE_PROJECT_REPONAME}_${VERSION}.${CIRCLE_BUILD_NUM}
              singularity build $BUILD_NAME.simg Singularity
      
